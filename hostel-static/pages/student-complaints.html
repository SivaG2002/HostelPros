<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Complaints - CampusConnect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../css/styles.css">
</head>

<body>

<script src="../js/app.js"></script>
<script>
  checkAuthAndRedirect();

  if (getUserRole() !== "student") {
    window.location.href = "admin-dashboard.html";
  }
</script>

<nav class="navbar">
  <div class="navbar-container">
    <div class="navbar-brand">CampusConnect</div>
    <div class="navbar-menu">
      <a href="student-dashboard.html">Dashboard</a>
      <a href="student-fees.html">Fees</a>
      <a href="student-notices.html">Notices</a>
      <a href="student-complaints.html" class="active">Complaints</a>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>
</nav>

<div class="main-content">

  <div class="flex justify-between items-center mb-6">
    <h1>My Complaints</h1>
    <button class="button button-primary" onclick="openComplaintModal()">
      ➕ File Complaint
    </button>
  </div>

  <div id="error-container"></div>
  <div id="success-container"></div>

  <div id="loading" class="loading">
    <div class="spinner"></div>
    Loading complaints...
  </div>

  <div id="complaints-container"></div>

</div>

<!-- MODAL -->
<div id="complaintModal"
style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">

  <div class="card" style="width:90%; max-width:500px;">
    <div class="card-header">
      <h2>File New Complaint</h2>
      <button onclick="closeComplaintModal()" style="background:none;border:none;font-size:1.5rem;">✕</button>
    </div>

    <div class="card-content">
      <form id="complaintForm">

        <div class="form-group">
          <label>Title</label>
          <input type="text" id="complaintTitle" required>
        </div>

        <div class="form-group">
          <label>Category</label>
          <select id="complaintCategory" required>
            <option value="">Select Category</option>
            <option value="maintenance">Maintenance</option>
            <option value="cleanliness">Cleanliness</option>
            <option value="water">Water Issue</option>
            <option value="electricity">Electricity</option>
            <option value="wifi">WiFi Issue</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea id="complaintDescription" rows="5" required></textarea>
        </div>

        <button type="submit" class="button button-primary w-full">
          Submit Complaint
        </button>

      </form>
    </div>
  </div>
</div>

<script>

setActiveNavLink("complaints");

function openComplaintModal() {
  document.getElementById("complaintModal").style.display = "flex";
}

function closeComplaintModal() {
  document.getElementById("complaintModal").style.display = "none";
}

// ---------------- LOAD COMPLAINTS ----------------
async function loadComplaints() {

  try {
    const userId = getUserId();

    const response = await fetch(`${API_URL}/complaints/student/${userId}/`);

    if (!response.ok) throw new Error("Failed to fetch complaints");

    const data = await response.json();

    document.getElementById("loading").style.display = "none";

    if (!data || data.length === 0) {
      document.getElementById("complaints-container").innerHTML =
        '<div class="card text-center text-muted">No complaints filed yet</div>';
      return;
    }

    let html = '';

    data.forEach(c => {

      const statusColor = {
        "pending": "badge-warning",
        "in-progress": "badge-primary",
        "resolved": "badge-success"
      }[c.status] || "badge-warning";

      html += `
        <div class="card mb-4">
          <div class="card-header">
            <div>
              <h3>${c.title}</h3>
              <p class="card-description">
                ${formatDate(c.created_at)} • ${c.category}
              </p>
            </div>
            <span class="badge ${statusColor}">
              ${c.status.toUpperCase()}
            </span>
          </div>
          <div class="card-content">
            <p>${c.description}</p>
          </div>
        </div>
      `;
    });

    document.getElementById("complaints-container").innerHTML = html;

  } catch (error) {
    document.getElementById("loading").style.display = "none";
    showError("Failed to load complaints.");
    console.error(error);
  }
}

// ---------------- CREATE COMPLAINT ----------------
document.getElementById("complaintForm")
.addEventListener("submit", async function(e) {

  e.preventDefault();

  try {

    const userId = getUserId();

    const response = await fetch(`${API_URL}/complaints/create/`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id: userId,
        title: document.getElementById("complaintTitle").value,
        category: document.getElementById("complaintCategory").value,
        description: document.getElementById("complaintDescription").value
      })
    });

    const result = await response.json();

    if (!response.ok) throw new Error(result.message);

    closeComplaintModal();
    showSuccess("Complaint submitted successfully");
    this.reset();
    loadComplaints();

  } catch (error) {
    showError("Failed to submit complaint.");
    console.error(error);
  }

});

loadComplaints();

</script>

</body>
</html>