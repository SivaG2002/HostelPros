<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Dashboard - CampusConnect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../css/styles.css">
</head>

<body>

<script src="../js/app.js"></script>
<script>
  checkAuthAndRedirect();

  if (getUserRole() !== "student") {
    window.location.href = "admin-dashboard.html";
  }
</script>

<!-- NAVBAR -->
<nav class="navbar">
  <div class="navbar-container">
    <div class="navbar-brand">CampusConnect</div>
    <div class="navbar-menu">
      <a href="student-dashboard.html" data-page="dashboard" class="active">Dashboard</a>
      <a href="student-fees.html" data-page="fees">Fees</a>
      <a href="student-notices.html" data-page="notices">Notices</a>
      <a href="student-complaints.html" data-page="complaints">Complaints</a>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>
</nav>

<!-- MAIN -->
<div class="main-content">

  <h1>Dashboard</h1>

  <div id="error-container"></div>

  <div id="loading" class="loading">
    <div class="spinner"></div>
    Loading dashboard...
  </div>

  <div id="dashboard-content" style="display:none;">

    <div class="grid grid-cols-3 space-y-6">

      <!-- PROFILE -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">My Profile</div>
        </div>
        <div class="card-content" id="profile-content"></div>
      </div>

      <!-- FEES -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Fees Summary</div>
        </div>
        <div class="card-content" id="fees-content"></div>
      </div>

      <!-- ROOM -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Room Info</div>
        </div>
        <div class="card-content" id="room-content"></div>
      </div>

    </div>

    <!-- NOTICE -->
    <div class="card mt-6" id="notice-card" style="display:none;">
      <div class="card-header">
        <div class="card-title">Latest Notice</div>
      </div>
      <div class="card-content" id="notice-content"></div>
    </div>

    <!-- COMPLAINT -->
    <div class="card mt-6" id="complaint-card" style="display:none;">
      <div class="card-header">
        <div class="card-title">Latest Complaint</div>
      </div>
      <div class="card-content" id="complaint-content"></div>
    </div>

  </div>

</div>

<script>

setActiveNavLink("dashboard");

async function loadStudentDashboard() {

  const userId = getUserId();
  if (!userId) {
    showError("User session invalid.");
    return;
  }

  try {

    const dashboardData = await fetch(`${API_URL}/student/dashboard/${userId}/`)
      .then(res => res.json());

    const latestNotice = await fetchLatestNotice();
    const latestComplaint = await fetchLatestComplaint(userId);

    document.getElementById("loading").style.display = "none";
    document.getElementById("dashboard-content").style.display = "block";

    // PROFILE
    document.getElementById("profile-content").innerHTML = `
      <p><strong>Name:</strong> ${dashboardData.name || "-"}</p>
      <p><strong>Email:</strong> ${dashboardData.email || "-"}</p>
    `;

    // FEES
    const paid = dashboardData.fees_paid;
    const total = dashboardData.total_fees || 0;
    const pending = dashboardData.pending_fees || 0;
    const statusColor = paid ? "green" : "red";

    document.getElementById("fees-content").innerHTML = `
      <div style="text-align:center;">
        <h2 style="color:${statusColor};">
          ${paid ? "All Fees Paid" : "Pending Fees"}
        </h2>
        <p>Total: ${formatCurrency(total)}</p>
        <p>Pending: ${formatCurrency(pending)}</p>
        <a href="student-fees.html" class="button button-primary w-full mt-6">
          View Full Details
        </a>
      </div>
    `;

    // ROOM
    if (dashboardData.room_no) {
      document.getElementById("room-content").innerHTML = `
        <p><strong>Room Number:</strong> ${dashboardData.room_no}</p>
        <p><strong>Capacity:</strong> ${dashboardData.room_capacity}</p>
        <p><strong>Occupied:</strong> ${dashboardData.room_occupied}</p>
      `;
    } else {
      document.getElementById("room-content").innerHTML = `
        <p style="color:red;">Room not assigned yet.</p>
      `;
    }

    // NOTICE
    if (latestNotice && latestNotice.title) {
      document.getElementById("notice-card").style.display = "block";
      document.getElementById("notice-content").innerHTML = `
        <h3>${latestNotice.title}</h3>
        <p>${formatDate(latestNotice.created_at)}</p>
        <p>${latestNotice.description}</p>
      `;
    }

    // COMPLAINT
    if (latestComplaint && latestComplaint.title) {
      document.getElementById("complaint-card").style.display = "block";
      document.getElementById("complaint-content").innerHTML = `
        <h3>${latestComplaint.title}</h3>
        <p>${formatDate(latestComplaint.created_at)}</p>
        <p>Status: ${latestComplaint.status}</p>
      `;
    }

  } catch (error) {
    console.error(error);
    showError("Failed to load dashboard.");
  }
}

loadStudentDashboard();

</script>

</body>
</html>